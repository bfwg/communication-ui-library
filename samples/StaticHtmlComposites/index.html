<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <title>Basic example for CallComposite and ChatComposite</title>

  <!-- Ensure that fonts have loaded before tests are run -->
  <link rel="preload" href="./fonts/segoeui-regular.woff2" as="font" crossorigin="anonymous" />
  <link rel="preload" href="./fonts/segoeui-semibold.woff2" as="font" crossorigin="anonymous" />
  <link rel="preload" href="./fonts/segoeui-bold.woff2" as="font" crossorigin="anonymous" />
  <style>
    @font-face {
      font-weight: 400;
      src: url('./fonts/segoeui-regular.woff2') format('woff2');
      font-family: 'Segoe UI';
    }
    @font-face {
      font-weight: 600;
      src: url('./fonts/segoeui-semibold.woff2') format('woff2');
      font-family: 'Segoe UI';
    }
    @font-face {
      font-weight: 700;
      src: url('./fonts/segoeui-bold.woff2') format('woff2');
      font-family: 'Segoe UI';
    }
  </style>
</head>

<body>
  <!-- height need to be set for composite to fit the layout -->
  <div>Choose a chat thread:</div>
  <select name="chat thread" id="chat-thread"></select>
  <div id="chat-container" style="height: 45vh"></div>
  <!-- replace with https://github.com/Azure/communication-ui-library/releases/latest/download/chatComposite.js for development and prototyping -->
  <script src="./chatComposite.js"></script>
  <!-- replace with https://github.com/Azure/communication-ui-library/releases/latest/download/callComposite.js for development and prototyping -->
  <script src="./callComposite.js"></script>
  <script src="./service.js"></script>
  <script type="module">
    const loadChat = async function (chatUserDetails, threadId) {
      const { user, token } = {
        token: chatUserDetails.userToken,
        user: { communicationUserId: chatUserDetails.azureUserId }
      };

      const onFetchAvatarPersonaData = () =>
        new Promise((resolve) => {
          return resolve({
            imageUrl: this.profileImageUrl + this.selectedUserDetails.selectedUserResponse.username
          });
        });

      const onRenderMessage = (messageProps, defaultOnRender) => {
        messageProps.showDate = true;
        if (messageProps.message.mine) {
          messageProps.messageContainerStyle = {
            backgroundColor: '#007994',
            color: '#FFFFFF !important',
            borderRadius: '8px !important',
            right: 0,
            '& .ui-chat__messageheader': {
              textAlign: 'right'
            }
          };
        } else {
          messageProps.messageContainerStyle = {
            borderRadius: '8px !important',
            backgroundColor: 'white',
            left: 0
          };
        }
        return defaultOnRender ? defaultOnRender(messageProps) : '';
      };

      this.chatAdapter = await chatComposite.loadChatComposite(
        {
          displayName: chatUserDetails.fullName,
          threadId: threadId,
          endpoint: 'https://web-ui-dev.communication.azure.com',
          userId: user,
          token: token
        },
        document.getElementById('chat-container'),
        {
          options: { topic: false, participantPane: false },
          key: Date.now(),
          onFetchAvatarPersonaData: onFetchAvatarPersonaData,
          onRenderMessage: onRenderMessage
        }
      );
    };

    const threads = [
      {
        userToken: '<userToken>',
        azureUserId: '<azureUserId>',
        threadId: '<threadId>'
      },
      {
        userToken: '<userToken>',
        azureUserId: '<azureUserId>',
        threadId: '<threadId>'
      }
    ];

    threads.forEach((t, i) => {
      const option = document.createElement('option');
      option.text = t.threadId;
      option.value = '' + i;
      document.getElementById('chat-thread').appendChild(option);
    });

    document.getElementById('chat-thread').onchange = () => {
      var x = document.getElementById('chat-thread').value;
      const y = parseInt(x);
      const thread = threads[y];
      loadChat(thread, thread.threadId);
    };

    loadChat(threads[0], threads[0].threadId);

    window.onbeforeunload = () => {
      callAdapter.dispose();
      chatAdapter.dispose();
    };
  </script>
</body>
